<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../component/ayd-datatable.html">
<link rel="import" href="pf-transactions-form.html">

<dom-module id="pf-transactions">
  <template>
    <style>
      paper-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        --paper-fab-background: var(--accent-color);
      }
    </style>
    
    <ayd-datatable
      id="datatable"
      data="{{transactions}}"
      fields="[[transactionsFields]]">
    </ayd-datatable>

    <pf-transactions-form
      id="form"
      form-opened="[[formOpened]]"
      on-push="_onTransactionPush">
    </pf-transactions-form>

    <paper-fab icon="icons:add" on-tap="_onFabClicked"></paper-fab>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PfTransactions extends Polymer.Element {

      ready() {
        super.ready();
        this.database.bindNodeToProperty('transactions', 'transactions', this);
      }
      
      static get is() { 
        return 'pf-transactions';
      }
      
      static get properties() {
        return {
          title: {
            type: String,
            value: "All Transactions",
          },
          deleteAction: {
            type: Object,
            readOnly: true,
            notify: true,
            computed: '_computeDeleteAction(transactions.*)'
          },
          database: {
            type: Object
          },
          formOpened: {
            type: Boolean,
            value: false
          },
          transactions: {
            type: Array,
            value: function() {
              return [];
            }
          },
          transactionsFields: {
            type: Array,
            value: function() {
              return {
                'date': 'Date', 
                'description': 'Description', 
                'amount': 'Amount'
              }
            }
          }
        };
      }

      _onFabClicked() {
        this.$.form.openDialog();
      }

      _onTransactionPush(e) {
        this.database.pushToNode('transactions', e.detail.model);
      }

      _computeDeleteAction(changeRecord) {
        if(changeRecord) {
          const selectedTransactions = changeRecord.base.filter(e => e.selected);
          const count = selectedTransactions.length;
          const enabled = count > 0;
          const execute = () => {
            selectedTransactions.forEach(transaction => this.database.removeNode(`transactions/${transaction.key}`));
          }
          return { enabled, count, execute };
        }
      }

    }

    window.customElements.define(PfTransactions.is, PfTransactions);
  </script>
</dom-module>
