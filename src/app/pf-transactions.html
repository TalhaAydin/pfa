<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../component/ayd-datatable.html">
<link rel="import" href="../mixin/ayd-firebase.html">
<link rel="import" href="../mixin/ayd-redux.html">
<link rel="import" href="pf-transactions-form.html">

<dom-module id="pf-transactions">
  <template>
    <style>
      paper-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        --paper-fab-background: var(--accent-color);
      }
    </style>
    
    <ayd-datatable
      id="datatable"
      data="[[data]]"
      selected="{{selected}}"
      fields="[[fields]]">
    </ayd-datatable>

    <pf-transactions-form
      id="form"
      opened="{{formOpened}}">
    </pf-transactions-form>

    <paper-fab icon="icons:add" on-tap="_onFabTapped"></paper-fab>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PfTransactions extends Aydin.ReduxMixin(Aydin.FirebaseMixin(Polymer.Element)) {

      ready() {
        super.ready();
        this.onChildNodeAdded('transactions', data => this.dispatch({ type: TRANSACTION.ADD, payload: { key: data.key, data: data.val() } }));
        this.onChildNodeRemoved('transactions', data => this.dispatch({ type: TRANSACTION.REMOVE, payload: data.key }));
      }
      
      static get is() {
        return 'pf-transactions';
      }
      
      static get properties() {
        return {
          title: {
            type: String,
            value: "All transactions",
          },
          selected: {
            type: Array,
            observer: '_onSelectedChanged'
          },
          formOpened: {
            type: Boolean,
            value: false,
            notify: true
          },
          data: {
            type: Array,
            value: () => [],
            computed: 'computeFromState(state.transactions.data)'
          },
          fields: {
            type: Array,
            value: () => ({
              'date': 'Date',
              'description': 'Description',
              'amount': 'Amount'
            }),
            readOnly: true
          }
        };
      }

      _onFabTapped() {
        this.set('formOpened', true);
      }

      _onSelectedChanged(newValue = [], oldValue = []) {
        if(newValue.length !== oldValue.length) {
          this.dispatch({type: TRANSACTION.SELECT, payload: newValue});
        }
      }

    }

    window.customElements.define(PfTransactions.is, PfTransactions);
  </script>
</dom-module>
